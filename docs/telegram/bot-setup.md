# Telegram Bot Setup

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather –∏ grammY.

## –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ BotFather

Telegram ‚Üí [@BotFather](https://t.me/BotFather) ‚Üí `/start`

### 2. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞

```
/newbot
```

**BotFather —Å–ø—Ä–æ—Å–∏—Ç**:

1. **–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞** (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤):

   ```
   OpenClaw Bot
   ```

2. **Username –±–æ—Ç–∞** (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `bot`):
   ```
   openclaw_jicool_bot
   ```

### 3. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω

```
Done! Congratulations on your new bot.
You will find it at t.me/openclaw_jicool_bot

Here is your token:
123456789:ABCdefGHIjklMNOpqrsTUVwxyz-1234567890

Keep it safe!
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –¢–æ–∫–µ–Ω = –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É. –ù–∏–∫–æ–º—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ!

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞

### –ö–æ–º–∞–Ω–¥—ã

```
/setcommands
```

–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ ‚Üí –≤—Å—Ç–∞–≤—å—Ç–µ:

```
start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
plan - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ –∏ –ª–∏–º–∏—Ç—ã
usage - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
subscribe - –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Stars
cancel - –û—Ç–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ-–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
help - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
```

---

### –û–ø–∏—Å–∞–Ω–∏–µ

```
/setdescription
```

–í—Å—Ç–∞–≤—å—Ç–µ:

```
AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Stars.

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π trial –Ω–∞ 7 –¥–Ω–µ–π!
```

---

### –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

```
/setabouttext
```

–í—Å—Ç–∞–≤—å—Ç–µ:

```
–£–º–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä—è–º–æ –≤ Telegram
```

---

### –ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```
/setuserpic
```

–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (512x512 px, PNG/JPG).

---

### –ü–ª–∞—Ç–µ–∂–∏ (Telegram Stars)

```
/mybots
‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞
‚Üí Bot Settings
‚Üí Payments
‚Üí Connect Provider: Telegram Stars
```

‚úÖ –í–∫–ª—é—á–∏—Ç–µ **Telegram Stars** –∫–∞–∫ –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

---

### Privacy Mode (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å)

```
/setprivacy
‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞
‚Üí Disable
```

**–ó–∞—á–µ–º**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–æ—Ç—ã –≤ –≥—Ä—É–ø–ø–∞—Ö –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `/`. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Privacy Mode –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –≤–∏–¥–µ—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –î–ª—è DM (–ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤) Privacy Mode –Ω–µ –≤–ª–∏—è–µ—Ç.

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å grammY

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
pnpm add grammy
```

### –ë–∞–∑–æ–≤—ã–π setup

**–§–∞–π–ª**: `src/telegram/bot.ts`

```typescript
import { Bot } from "grammy";

const token = process.env.TELEGRAM_BOT_TOKEN!;
const bot = new Bot(token);

// Start command
bot.command("start", async (ctx) => {
  await ctx.reply("‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!");
});

// Plan command
bot.command("plan", async (ctx) => {
  const userId = ctx.from!.id;
  const user = await getUserRecord(userId);

  await ctx.reply(`
üìä –í–∞—à –ø–ª–∞–Ω: ${user.role}

‚è± –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: ${formatDate(user.expiresAt)}
üì® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è: ${user.messagesUsedToday}
ü§ñ –ú–æ–¥–µ–ª—å: ${user.model}
  `);
});

// Handle all messages
bot.on("message:text", async (ctx) => {
  const userId = ctx.from.id;
  const text = ctx.message.text;

  // Check access
  const allowed = await checkAccess(userId);
  if (!allowed) {
    return ctx.reply("‚ùå –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω. /subscribe");
  }

  // Send to AI agent
  const response = await sendToAgent(userId, text);
  await ctx.reply(response);
});

// Start bot
bot.start();
```

---

## Deep Links (Invite-—Å—Å—ã–ª–∫–∏)

### –§–æ—Ä–º–∞—Ç

```
https://t.me/openclaw_jicool_bot?start=PAYLOAD
```

- **PAYLOAD**: –¥–æ 64 —Å–∏–º–≤–æ–ª–æ–≤ (`A-Z a-z 0-9 _ -`)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ payload

```typescript
bot.command("start", async (ctx) => {
  const payload = ctx.match; // –í—Å–µ –ø–æ—Å–ª–µ /start

  if (!payload) {
    // –û–±—ã—á–Ω—ã–π /start
    return ctx.reply("–ü—Ä–∏–≤–µ—Ç! –¢—ã –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.");
  }

  if (payload.startsWith("inv_")) {
    // Invite-–∫–æ–¥
    const inviteCode = payload;
    await activateVIP(ctx.from.id, inviteCode);
    return ctx.reply("‚úÖ VIP –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
  }

  if (payload.startsWith("ref_")) {
    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
    const referrerId = decodeReferral(payload);
    await linkReferral(ctx.from.id, referrerId);
    return ctx.reply("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã –ø—Ä–∏—à–ª–∏ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ.");
  }
});
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è invite-—Å—Å—ã–ª–∫–∏

```typescript
bot.command("invite", async (ctx) => {
  // –¢–æ–ª—å–∫–æ –¥–ª—è owner
  if (!isOwner(ctx.from.id)) {
    return ctx.reply("‚ùå –¢–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞");
  }

  const label = ctx.match; // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ /invite
  const inviteCode = generateInviteCode(ctx.from.id);

  const link = `https://t.me/${bot.botInfo.username}?start=${inviteCode}`;

  await ctx.reply(`
‚úÖ VIP invite-—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:

${link}

Label: ${label}
–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –±–µ—Å—Å—Ä–æ—á–Ω–æ
  `);
});
```

---

## Telegram Stars (–ü–ª–∞—Ç–µ–∂–∏)

### –û—Ç–ø—Ä–∞–≤–∫–∞ invoice

```typescript
bot.command("subscribe", async (ctx) => {
  const userId = ctx.from.id;

  // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–∞—Ä–∏—Ñ–æ–≤
  await ctx.reply("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ:", {
    reply_markup: {
      inline_keyboard: [
        [{ text: "Starter ‚Äî 100 ‚≠ê/–º–µ—Å", callback_data: "subscribe_starter" }],
        [{ text: "Premium ‚Äî 300 ‚≠ê/–º–µ—Å", callback_data: "subscribe_premium" }],
      ],
    },
  });
});

bot.callbackQuery("subscribe_starter", async (ctx) => {
  await ctx.answerCallbackQuery();

  await ctx.api.sendInvoice(ctx.from.id, {
    title: "Starter Plan",
    description: "30 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å, —Å—Ä–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å",
    payload: JSON.stringify({ plan: "starter", userId: ctx.from.id }),
    currency: "XTR", // Telegram Stars
    prices: [{ label: "Starter", amount: 100 }],
    subscription_period: 2592000, // 30 –¥–Ω–µ–π –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  });
});
```

### Pre-checkout handler

```typescript
bot.on("pre_checkout_query", async (ctx) => {
  const payload = JSON.parse(ctx.preCheckoutQuery.invoice_payload);

  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  const user = await getUserRecord(payload.userId);
  if (!user) {
    return ctx.answerPreCheckoutQuery(false, {
      error_message: "User not found",
    });
  }

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (< 10 —Å–µ–∫—É–Ω–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
  await ctx.answerPreCheckoutQuery(true);
});
```

### Successful payment handler

```typescript
bot.on("message:successful_payment", async (ctx) => {
  const payment = ctx.message.successful_payment;
  const payload = JSON.parse(payment.invoice_payload);

  // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
  await activateSubscription(payload.userId, payload.plan, payment.telegram_payment_charge_id);

  await ctx.reply(`
‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!

üìä –í–∞—à –Ω–æ–≤—ã–π –ø–ª–∞–Ω: ${payload.plan}
‚è± –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: ${formatDate(Date.now() + 30 * 24 * 60 * 60 * 1000)}
  `);
});
```

---

## Error Handling

```typescript
bot.catch((err) => {
  console.error("Bot error:", err);

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ owner
  bot.api.sendMessage(
    OWNER_TELEGRAM_ID,
    `
‚ö†Ô∏è –û—à–∏–±–∫–∞ –±–æ—Ç–∞:

${err.message}

Stack:
${err.stack}
  `,
  );
});
```

---

## Webhook (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ polling)

### Setup webhook

```typescript
const WEBHOOK_URL = "https://your-bot.com/webhook";
const WEBHOOK_SECRET = process.env.TELEGRAM_WEBHOOK_SECRET;

await bot.api.setWebhook(WEBHOOK_URL, {
  secret_token: WEBHOOK_SECRET,
});
```

### Handle webhook

```typescript
import express from "express";

const app = express();
app.use(express.json());

app.post("/webhook", async (req, res) => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ secret
  if (req.headers["x-telegram-bot-api-secret-token"] !== WEBHOOK_SECRET) {
    return res.status(401).send("Unauthorized");
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ update
  await bot.handleUpdate(req.body);
  res.sendStatus(200);
});

app.listen(8080);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ webhook**:

- –ú–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Telegram API

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**:

- HTTPS
- –ü—É–±–ª–∏—á–Ω—ã–π URL

---

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

- [grammY Framework](/telegram/grammyjs) ‚Äî –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ grammY
- [Deep Linking](/telegram/deep-linking) ‚Äî invite-—Å—Å—ã–ª–∫–∏
- [Payment Handlers](/telegram/payment-handlers) ‚Äî —Ä–∞–±–æ—Ç–∞ —Å Stars
- [Setup Guide](/admin/setup) ‚Äî –ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞
